<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>快速记</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="{{ url_for('static', filename='css/transaction.css') }}" rel="stylesheet" />
        <!-- import CSS -->
        <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
<!--<link rel="stylesheet" href="{{ url_for('static', filename='css/element.css') }}">-->
    </head>
    <body>
        <div id="app">

            <div class="d-flex" id="wrapper">
                <!-- Sidebar-->
                <div class="border-end bg-white" id="sidebar-wrapper">
                    <div class="sidebar-heading border-bottom {{ classes}}">{{title}}</div>
                    <div class="list-group list-group-flush">
                        <a class="list-group-item list-group-item-action list-group-item-light p-3" @click="activeType=0" >概览</a>
                        <a class="list-group-item list-group-item-action list-group-item-light p-3" @click="activeType=1">年度账单</a>
                        <a class="list-group-item list-group-item-action list-group-item-light p-3" @click="activeType=2" >趋势图</a>
                        <a class="list-group-item list-group-item-action list-group-item-light p-3" @click="activeType=3" >成员消费图</a>
                        <a class="list-group-item list-group-item-action list-group-item-light p-3" @click="activeType=4" >总结</a>
                    </div>
                </div>
                <!-- Page content wrapper-->
                <div id="page-content-wrapper">
                    <!-- Top navigation-->
                    <nav class="navbar navbar-expand-lg navbar-light border-bottom {{ classes }}">
                        <div class="container-fluid">
                            <div class="collapse navbar-collapse" id="navbarSupportedContent">

                                <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                                    <li class="nav-item active"><a class="nav-link" href="/">主页</a></li>
                                    <li class="nav-item"><a class="nav-link" href="/transaction">记账</a></li>
                                    <li class="nav-item"><a class="nav-link" href="/report">报表</a></li>
                                </ul>
                            </div>
                        </div>
                    </nav>


                     {% raw %}
                    <!-- Page content-->
                    <div class="container-fluid">
                        <!--    概览  -->
                        <div v-show="activeType===0">
                            <h2 class="mt-4">消费行为图</h2>
                            <el-form :inline="true" :model="formPie" class="demo-form-inline">
                              <el-form-item>
                                   <el-date-picker
                                      v-model="formPie.date"
                                      type="month"
                                     value-format="yyyy-MM"
                                      placeholder="选择月">
                                    </el-date-picker>
                              </el-form-item>
                                 <el-form-item>
                                    <el-select
                                            clearable
                                            v-model="formPie.accountType"
                                               placeholder="请选择账户">
                                      <el-option v-for="op in selectOptionAccountType" :label="op.label" :value="op.value"></el-option>
                                    </el-select>
                                </el-form-item>
                              <el-form-item>
                                <el-button type="primary" @click="onSearch">查询</el-button>
                              </el-form-item>
                            </el-form>
                            <div id="pie-chart" style="width: 600px;height:400px;"></div>
                        </div>
                         <!--    年消费汇总  -->
                        <div v-show="activeType===1">
                            <h1 class="mt-4">年消费汇总</h1>
                               <el-form :inline="true" :model="formBar" class="demo-form-inline bg-light pt-4">
                                  <el-date-picker
                                      v-model="formBar.date"
                                      type="year"
                                      value-format="yyyy"
                                      placeholder="选择年">
                                    </el-date-picker>
                                  <el-form-item>
                                    <el-button type="primary" @click="formBarSearch" >查询</el-button>
                                    <el-button @click="formBarExport" >导出EXCEL</el-button>
                                  </el-form-item>
                               </el-form>
                            <div id="bar-chart" style="width: 1000px;height:400px;"></div>
                            <div>
                                <h3>平均每月消费：{{formBarAVG}}</h3>
                            </div>
                        </div>
                         <!--   消费趋势  -->
                        <div v-show="activeType===2">
                            <h1 class="mt-4">消费趋势</h1>
                               <el-form :inline="true" :model="formLine" class="demo-form-inline bg-light pt-4">
                               </el-form-item>
                                    <el-cascader
                                        placeholder="分类"
                                        clearable
                                        v-model="formLine.category"
                                        :options="options"
                                        filterable>
                                    </el-cascader>
                                    <el-date-picker
                                      v-model="formLine.trans_time"
                                      type="daterange"
                                      value-format="yyyy-MM-dd"
                                      @change="dateChange"
                                      unlink-panels
                                      start-placeholder="开始月份"
                                      end-placeholder="结束月份"
                                      :picker-options="formLine.pickerOptions">
                                    </el-date-picker>
                                    <el-select
                                            clearable
                                            v-model="formLine.consumer"
                                            placeholder="成员">
                                      <el-option v-for="op in selectOptionConsumer" :label="op.label" :value="op.value"></el-option>
                                    </el-select>
                                    <el-select
                                        clearable
                                        v-model="formLine.accountType"
                                        placeholder="账户">
                                      <el-option v-for="op in selectOptionAccountType" :label="op.label" :value="op.value"></el-option>
                                    </el-select>
                              <el-form-item>
                                <el-button type="primary" @click="formLineSearch" >查询</el-button>
                              </el-form-item>
                            </el-form>
                            <div id="line-chart" style="width: 1000px;height:400px;"></div>
                            <div>
                                <h3>平均每月消费：{{formLineAVG}}</h3>
                            </div>
                        </div>
                         <!--    改账  -->
                        <div v-show="activeType===3" class="p-2">
                            <h1 class="mt-2">消费成员</h1>

                        </div>
                         <!--    分析  -->
                        <div v-show="activeType===4">
                            <h1 class="mt-4">4</h1>
                        </div>
                    </div>
                </div>
            </div>


        </div>
        {% endraw %}
        <!-- import echarts -->
        <script src="{{ url_for('static', filename='js/lib/echarts.js') }}"></script>
         <!-- import Vue before Element -->
        <script src="{{ url_for('static', filename='js/lib/vue.js') }}"></script>
        <!-- import enum.js -->
        <script src="{{ url_for('static', filename='js/const.js') }}"></script>
        <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
        <!-- Bootstrap core JS-->
        <script src="{{ url_for('static', filename='js/lib/bootstrap.js') }}"></script>
        <!-- dayjs -->
        <script src="{{ url_for('static', filename='js/lib/dayjs.js') }}"></script>
         <!-- import element-ui -->
        <script src="{{ url_for('static', filename='js/lib/element-ui.js') }}"></script>
        <!-- import axios -->
        <script src="{{ url_for('static', filename='js/lib/axios.js') }}"></script>

          <!-- import componet.js -->
        <script src="{{ url_for('static', filename='js/components.js') }}"></script>
        <script src="{{ url_for('static', filename='js/echart.js') }}"></script>
        <script type="text/javascript">
              // vue
             new Vue({
              el: '#app',
              created: function () {
                    const date = new Date().getFullYear()
                    const trans_time = [date + '-01-01 00:00:00', date + '-12-31 23:59:59']
                    axios.post('/report/get/month/amount',{trans_time})
                    .then(function (response) {
                        barInit(response.data.data)
                    }).catch(function (error) {
                        console.log(error);
                    });
              },
              computed:{
                formLineAVG: function(){
                    const arr = this.formLine.data;
                    if(arr.length > 0) {
                        total = arr.reduce((p,c)=>Number(p)+Number(c))
                        console.log(total)
                        return __utils.numFormat(total/arr.length)
                    }
                    return 0
                },
                formBarAVG: function(){
                    const arr = this.formBar.data;
                    if(arr.length > 0) {
                        total = arr.reduce((p,c)=>Number(p)+Number(c))
                        console.log(total)
                        return __utils.numFormat(total/arr.length)
                    }
                    return 0
                },
              },
              data: function() {
                return {
                    activeType: 0,
                    formPie:{
                        date: undefined
                    },
                    
                    formLine:{
                        accountType: undefined,
                        tag: undefined,
                        category: undefined,
                        consumer: undefined,
                        pickerOptions: __pickerOptions,
                        data: [],
                    },
                    formBar:{
                        date: undefined,
                        data: [],
                    },

                    selectOptionAccountType: __enum.getAccountType(),

                    options: __enum.categoryType,
                    selectOption: __enum.getTag(),
                    selectOptionConsumer: __enum.getConsumer(),
                    selectOptionAccountType: __enum.getAccountType(),
                    selectOptionPaymentType: __enum.getPaymentType(),

                }
              },
              methods: {
                  dateChange(val){
                      val[0] = val[0] + "T00:00:00"
                      val[1] = val[1] + "T23:59:59"
                      return val
                  },
                  formLineSearch() {
                      const _this = this
                      axios.post('/report/month/track',{
                         ..._this.formLine},
                      )
                        .then(function (res) {
                            const data = res.data.data
                               lineInit(data)
                               _this.formLine.data = data.value
                        }).catch(function (error) {
                            console.log(error);
                        });
                  },
                  formBarSearch() {
                      const _this = this
                      const date = this.formBar.date
                      const trans_time = [date + '-01-01 00:00:00', date + '-12-31 23:59:59']
                       axios.post('/report/get/month/amount',{trans_time})
                        .then(function (res) {
                            const data = res.data.data
                            barInit(data)
                            _this.formBar.data = data.value
                        }).catch(function (error) {
                            console.log(error);
                        });
                  },
                  formBarExport(){
                      const date = this.formBar.date
                      const _this = this
                      const trans_time = [date + '-01-01 00:00:00', date + '-12-31 23:59:59']
                      axios.post('/report/excel/export',{
                            categoryObj: __enum.categoryType,
                           trans_time
                       })
                        .then(function (response) {
                            _this.$message({
                                      message: '成功',
                                      type: 'success'
                                   })
                        }).catch(function (error) {
                            console.log(error);
                        });
                  },
                  onSearch(){
                      const _this = this
                      const date = this.formPie.date;
                      const firstDay = dayjs(date).format("YYYY-MM-DD HH:mm:ss")
                      const endDay = dayjs(date).endOf('month').format("YYYY-MM-DD HH:mm:ss")
                      axios.post('/report/month/bill',{
                          categoryObj: __enum.getCategoryObj(),
                          trans_time: [firstDay, endDay],..._this.formPie},
                      )
                        .then(function (res) {
                            const data = res.data.data
                               pieInit(data)
                        }).catch(function (error) {
                            console.log(error);
                        });
                  },
              },
              mounted() {
                  this.$nextTick(function () {
                    // 仅在整个视图都被渲染之后才会运行的代码
                       // 基于准备好的dom，初始化echarts实例
                       //    lineInit()
                  })
                }

            })
        </script>
    </body>
</html>